<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lumera: Find a song based on your mood</title>
    <link rel="icon" type="image/png" href="assets/favicon.png" />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <div class="lumera-header" id="lumeraHeader">
      <img src="assets/lumera.png" alt="Lumera Logo" class="lumera-logo" />
      <span class="lumera-title">Lumera</span>
    </div>
    <div class="skip-button" id="skipButton">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
        <path d="M4 18l8.5-6L4 6v12zm9-12v12l8.5-6L13 6z" />
      </svg>
      <span>skip</span>
    </div>
    <div class="mountain-background"></div>
    <div class="mountain-silhouette"></div>
    <div class="mountain-layer-2"></div>
    <div class="mountain-layer-3"></div>

    <div class="content-container">
      <!-- First text that fades in and out -->
      <h1 id="firstText" class="fade-text">LUMERA</h1>

      <!-- Second phase with dual text -->
      <div id="dualTextContainer" class="dual-text-container">
        <h2 id="firstDualText" class="dual-text">PICK A SONG YOU LIKE</h2>
        <h2 id="secondDualText" class="dual-text">PICK A MOOD YOU WANT</h2>
      </div>

      <!-- Tutorial page -->
      <div id="tutorialContainer" class="tutorial-container">
        <h2 class="tutorial-headline">How To Use</h2>
        <div class="tutorial-steps">
          <div class="tutorial-step">
            <div class="step-number">1</div>
            <div class="step-title"></div>
            <div class="step-description">
              pick a song you're into right now
            </div>
          </div>
          <div class="tutorial-step">
            <div class="step-number">2</div>
            <div class="step-title"></div>
            <div class="step-description">pick a mood you want</div>
          </div>
          <div class="tutorial-step">
            <div class="step-number">3</div>
            <div class="step-title"></div>
            <div class="step-description">submit & let the music take over</div>
          </div>
        </div>
        <button class="get-started-btn">get started</button>
      </div>

      <!-- Search bar -->
      <div id="searchContainer" class="search-container">
        <div class="search-helper-text">Find the tune. Flip the mood.</div>
        <div class="search-wrapper">
          <input
            type="text"
            class="glass-search-bar"
            placeholder="Search for songs here..."
            id="songSearch"
          />
          <div class="search-results" id="searchResults"></div>
        </div>

        <div class="dropdown-and-submit">
          <select class="glass-dropdown">
            <option disabled selected>Select a mood</option>
            <option value="calm">Calm</option>
            <option value="moody">Moody</option>
            <option value="uplifting">Uplifting</option>
            <option value="melancholy">Melancholy</option>
            <option value="romantic">Romantic</option>
            <option value="dark">Dark</option>
            <option value="euphoric">Euphoric</option>
            <option value="nostalgic">Nostalgic</option>
            <option value="angsty">Angsty</option>
            <option value="hopeful">Hopeful</option>
          </select>

          <button class="submit-btn">submit</button>
        </div>
      </div>
    </div>

    <div id="haPage" class="ha-page">
      <div class="ha-back-button" id="haBackButton">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
          <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6z" />
        </svg>
        <span>back</span>
      </div>
      <div class="ha-content" id="haContent">
        <!-- Song content will be populated here -->
      </div>
    </div>

    <script>
      // Animation sequence
      function startAnimationSequence() {
        const firstText = document.getElementById("firstText");
        const dualTextContainer = document.getElementById("dualTextContainer");
        const firstDualText = document.getElementById("firstDualText");
        const secondDualText = document.getElementById("secondDualText");
        const tutorialContainer = document.getElementById("tutorialContainer");
        const searchContainer = document.getElementById("searchContainer");
        const lumeraHeader = document.getElementById("lumeraHeader");
        const skipButton = document.getElementById("skipButton");

        let isSkipped = false; // Add this flag

        // Skip button functionality
        skipButton.addEventListener("click", () => {
          isSkipped = true; // Set flag to prevent all animations
          skipButton.style.display = "none";

          // Hide all animation elements immediately
          firstText.classList.remove("visible");
          dualTextContainer.classList.remove("visible");
          firstDualText.classList.remove("visible");
          secondDualText.classList.remove("visible");

          // Show tutorial and header immediately
          setTimeout(() => {
            tutorialContainer.classList.add("visible");
            lumeraHeader.classList.add("visible");
          }, 100);
        });

        // ðŸ”¥ TIMING CONTROLS - Only run if not skipped
        // Phase 1: Show "LUMERA"
        setTimeout(() => {
          if (!isSkipped) firstText.classList.add("visible");
        }, 500);

        // Phase 2: Hide first text and show dual text container
        setTimeout(() => {
          if (!isSkipped) firstText.classList.remove("visible");
        }, 3000);

        setTimeout(() => {
          if (!isSkipped) {
            dualTextContainer.classList.add("visible");
            firstDualText.classList.add("visible");
          }
        }, 4000);

        // Phase 3: Show second dual text below the first
        setTimeout(() => {
          if (!isSkipped) secondDualText.classList.add("visible");
        }, 6500);

        // Phase 4: Hide both dual texts and show tutorial
        setTimeout(() => {
          if (!isSkipped) {
            firstDualText.classList.remove("visible");
            secondDualText.classList.remove("visible");
            dualTextContainer.classList.remove("visible");
          }
        }, 8500);

        setTimeout(() => {
          if (!isSkipped) {
            tutorialContainer.classList.add("visible");
            lumeraHeader.classList.add("visible");
            skipButton.style.display = "none";
          }
        }, 10000);

        // Phase 5: Show search bar when "get started" is clicked
        const getStartedBtn = document.querySelector(".get-started-btn");
        getStartedBtn.addEventListener("click", () => {
          tutorialContainer.classList.remove("visible");
          setTimeout(() => {
            searchContainer.classList.add("visible");
          }, 600);
        });

        const submitBtn = document.querySelector(".submit-btn");
        getStartedBtn.addEventListener("click", () => {
          tutorialContainer.classList.remove("visible");
          setTimeout(() => {
            searchContainer.classList.add("visible");
          }, 600);
        });
      }

      // Spotify search functionality
      let searchTimeout;
      let selectedSong = null;

      function initializeSpotifySearch() {
        const searchBar = document.getElementById("songSearch");
        const searchResults = document.getElementById("searchResults");

        searchBar.addEventListener("input", function (e) {
          const query = e.target.value.trim();

          // Clear previous timeout
          clearTimeout(searchTimeout);

          if (query.length === 0) {
            searchResults.innerHTML = "";
            searchResults.style.display = "none";
            return;
          }

          // Debounce search requests
          searchTimeout = setTimeout(() => {
            searchSpotify(query);
          }, 300);
        });

        // Hide results when clicking outside
        document.addEventListener("click", function (e) {
          if (!e.target.closest(".search-wrapper")) {
            searchResults.style.display = "none";
          }
        });
      }

      async function searchSpotify(query) {
        const searchResults = document.getElementById("searchResults");

        try {
          const response = await fetch(
            `/api/search?q=${encodeURIComponent(query)}`
          );
          const data = await response.json();

          if (data.tracks && data.tracks.length > 0) {
            displaySearchResults(data.tracks);
          } else {
            searchResults.innerHTML =
              '<div class="no-results">No songs found</div>';
            searchResults.style.display = "block";
          }
        } catch (error) {
          console.error("Search error:", error);
          searchResults.innerHTML =
            '<div class="error-message">Search failed. Please try again.</div>';
          searchResults.style.display = "block";
        }
      }

      function displaySearchResults(tracks) {
        const searchResults = document.getElementById("searchResults");

        searchResults.innerHTML = tracks
          .map(
            (track) => `
      <div class="search-result-item" data-track-id="${
        track.id
      }" data-track-name="${track.name}" data-track-artists="${track.artists}">
        <div class="track-info">
          <div class="track-name">${track.name}</div>
          <div class="track-artist">${track.artists}</div>
        </div>
        ${
          track.image
            ? `<img src="${track.image}" alt="Album cover" class="track-image">`
            : ""
        }
      </div>
    `
          )
          .join("");

        searchResults.style.display = "block";

        // Add click handlers to results
        searchResults
          .querySelectorAll(".search-result-item")
          .forEach((item) => {
            item.addEventListener("click", function () {
              const trackName = this.dataset.trackName;
              const trackArtists = this.dataset.trackArtists;
              const trackId = this.dataset.trackId;

              // Update search bar with selected song
              document.getElementById(
                "songSearch"
              ).value = `${trackName} - ${trackArtists}`;

              // Store selected song data
              selectedSong = {
                id: trackId,
                name: trackName,
                artists: trackArtists,
                image: this.querySelector(".track-image")?.src || "",
                spotifyUrl: `https://open.spotify.com/track/${trackId}`,
              };

              // Hide results
              searchResults.style.display = "none";
            });
          });
      }

      // Start the animation when page loads
      window.addEventListener("load", () => {
        startAnimationSequence();
        initializeSpotifySearch();
      });

      // Remove focus from dropdown after selection
      const glassDropdown = document.querySelector(".glass-dropdown");
      if (glassDropdown) {
        glassDropdown.addEventListener("change", function (e) {
          e.target.blur();
        });
      }

      // Submit button fade to 'ha.' page
      const submitBtn = document.querySelector(".submit-btn");
      const searchContainer = document.getElementById("searchContainer");
      const haPage = document.getElementById("haPage");
      if (submitBtn && searchContainer && haPage) {
        haPage.style.display = "none";
        haPage.style.opacity = 0;
        submitBtn.addEventListener("click", function () {
          // Populate haPage with selectedSong info
          if (selectedSong) {
            const haContent = document.getElementById("haContent");

            // Clear existing content
            haContent.innerHTML = "";

            // Create song display container
            const songDisplay = document.createElement("div");
            songDisplay.className = "song-display";

            // Create song image
            const songImage = document.createElement("img");
            songImage.src = selectedSong.image;
            songImage.alt = "Album cover";
            songImage.className = "song-image";

            // Create song info container
            const songInfo = document.createElement("div");
            songInfo.className = "song-info";

            // Create song title
            const songTitle = document.createElement("div");
            songTitle.className = "song-title";
            songTitle.textContent = selectedSong.name;

            // Create song artist
            const songArtist = document.createElement("div");
            songArtist.className = "song-artist";
            songArtist.textContent = selectedSong.artists;

            // Create button container
            const buttonContainer = document.createElement("div");
            buttonContainer.className = "button-container";

            // Create Spotify button
            const spotifyBtn = document.createElement("a");
            spotifyBtn.href = selectedSong.spotifyUrl;
            spotifyBtn.target = "_blank";
            spotifyBtn.className = "spotify-btn";

            // Create Spotify button content
            const spotifyIcon = document.createElement("img");
            spotifyIcon.src = "assets/spotify.svg";
            spotifyIcon.alt = "Spotify";
            spotifyIcon.width = 20;
            spotifyIcon.height = 20;

            const spotifyText = document.createElement("span");
            spotifyText.textContent = "open on spotify";

            spotifyBtn.appendChild(spotifyIcon);
            spotifyBtn.appendChild(spotifyText);

            // Create reroll button
            const rerollBtn = document.createElement("button");
            rerollBtn.className = "reroll-btn";
            rerollBtn.textContent = "reroll";

            // Add click handler for reroll button
            rerollBtn.addEventListener("click", function () {
              // You can add reroll functionality here
              console.log("Reroll clicked");
            });

            // Append elements
            buttonContainer.appendChild(spotifyBtn);
            buttonContainer.appendChild(rerollBtn);

            songInfo.appendChild(songTitle);
            songInfo.appendChild(songArtist);
            songInfo.appendChild(buttonContainer);

            songDisplay.appendChild(songImage);
            songDisplay.appendChild(songInfo);

            haContent.appendChild(songDisplay);
          } else {
            const haContent = document.getElementById("haContent");
            haContent.innerHTML =
              '<div style="color:white;font-size:2rem;">No song selected.</div>';
          }

          searchContainer.style.transition = "opacity 0.7s";
          searchContainer.style.opacity = 0;
          setTimeout(() => {
            searchContainer.style.display = "none";
            haPage.style.display = "flex";
            setTimeout(() => {
              haPage.style.opacity = 1;
            }, 50);
          }, 700);
        });
      }

      // Add back button functionality
      const haBackButton = document.getElementById("haBackButton");
      if (haBackButton) {
        haBackButton.addEventListener("click", function () {
          haPage.style.transition = "opacity 0.7s";
          haPage.style.opacity = 0;
          setTimeout(() => {
            haPage.style.display = "none";
            searchContainer.style.display = "block";
            setTimeout(() => {
              searchContainer.style.opacity = 1;
            }, 50);
          }, 700);
        });
      }
    </script>
  </body>
</html>
